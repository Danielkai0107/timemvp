# 報名者狀態更新修復文檔

## 問題描述

之前的實現中，當主辦者提前結束活動時，只更新了活動本身的狀態為 `ended`，但沒有同步更新所有報名者的狀態。這導致報名者的狀態仍然顯示為 `registered`（報名成功），而不是 `ended`（已結束）。

## 修復方案

### 1. 新增批量更新方法

在 `ActivityService` 中新增了 `updateAllRegistrationStatusForActivity` 方法：

```dart
Future<void> updateAllRegistrationStatusForActivity({
  required String activityId,
  required String newStatus,
}) async {
  // 批量更新該活動所有報名者的狀態
}
```

**功能特點：**
- 查詢該活動的所有報名記錄
- 使用 Firestore 批量操作提高效率
- 只更新狀態為 `registered` 的記錄（保留已取消的報名狀態）
- 記錄詳細的調試信息

### 2. 新增統一的提前結束方法

新增了 `endActivityEarly` 方法，統一處理提前結束的完整流程：

```dart
Future<void> endActivityEarly({
  required String activityId,
}) async {
  // 1. 更新活動狀態為已結束
  // 2. 更新所有報名者狀態為已結束
}
```

**執行順序：**
1. 更新活動狀態為 `ended`
2. 批量更新所有報名者狀態為 `ended`
3. 確保數據一致性

### 3. 更新評分彈窗顯示邏輯

修改了 `shouldShowRatingPopup` 方法，增加對報名者狀態的檢查：

```dart
// 檢查活動是否已結束的條件：
// 1. 活動狀態為 'ended'，或
// 2. 報名狀態為 'ended'，或  
// 3. 當前時間已超過活動結束時間
if (activityStatus == 'ended' || registrationStatus == 'ended') {
  isActivityEnded = true;
}
```

**改進點：**
- 同時檢查活動狀態和報名狀態
- 任一狀態為 `ended` 都會觸發評分流程
- 增加詳細的調試日誌

### 4. 更新前端調用邏輯

修改活動詳情頁面的 `_handleEarlyEndActivity` 方法：

```dart
// 使用新的提前結束方法，會同時更新活動和報名者狀態
await _activityService.endActivityEarly(
  activityId: widget.activityId,
);
```

**用戶體驗改進：**
- 更新載入提示文字，說明正在更新報名者狀態
- 更新成功提示，確認所有狀態已更新
- 保持原有的頁面刷新邏輯

## 數據流程

### 提前結束活動流程

1. **主辦者操作**
   - 點擊"提前結束活動"按鈕
   - 確認提前結束

2. **後端處理**
   - 更新活動狀態：`active` → `ended`
   - 查詢所有報名記錄
   - 批量更新報名狀態：`registered` → `ended`

3. **前端更新**
   - 重新載入活動詳情
   - 刷新相關頁面數據
   - 顯示成功提示

### 評分觸發流程

1. **參與者訪問**
   - 打開活動詳情頁面
   - 系統檢查評分條件

2. **狀態檢查**
   - 檢查活動狀態是否為 `ended`
   - 檢查報名狀態是否為 `ended`
   - 檢查是否已評分過

3. **評分彈窗**
   - 符合條件時自動顯示評分界面
   - 用戶完成評分後保存到資料庫

## 數據一致性保證

### Firestore 批量操作
- 使用 `batch.commit()` 確保所有更新操作的原子性
- 如果任何一個更新失敗，整個批量操作會回滾

### 錯誤處理
- 詳細的錯誤日誌記錄
- 友好的用戶錯誤提示
- 不會因為部分失敗而影響整體功能

### 狀態保護
- 只更新狀態為 `registered` 的報名記錄
- 保留已取消報名（`cancelled`）的狀態
- 避免覆蓋其他有效狀態

## 測試驗證

### 功能測試
1. **提前結束測試**
   - 主辦者提前結束活動
   - 驗證活動狀態變為 `ended`
   - 驗證所有報名者狀態變為 `ended`

2. **評分觸發測試**
   - 參與者打開活動詳情頁
   - 驗證評分彈窗正確顯示
   - 驗證評分功能正常工作

3. **狀態保護測試**
   - 已取消報名的用戶狀態不應被更新
   - 只有 `registered` 狀態會被更新為 `ended`

### 邊界情況測試
1. **網絡錯誤**
   - 批量更新失敗時的錯誤處理
   - 部分更新成功時的數據一致性

2. **並發操作**
   - 多個用戶同時操作時的數據安全
   - 狀態更新的時序問題

## 影響範圍

### 直接影響
- 活動詳情頁面的提前結束功能
- 評分彈窗的顯示邏輯
- 我的活動頁面的狀態顯示

### 間接影響
- 活動狀態統計的準確性
- 用戶體驗的一致性
- 數據分析的可靠性

## 未來優化建議

1. **通知系統**
   - 活動提前結束時通知所有參與者
   - 評分邀請的推送通知

2. **狀態歷史**
   - 記錄狀態變更的時間戳
   - 追蹤狀態變更的原因

3. **批量操作優化**
   - 對大量報名記錄的分批處理
   - 進度顯示和取消機制

4. **數據同步**
   - 實時同步狀態變更
   - 離線狀態的處理機制
