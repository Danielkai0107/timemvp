# 活動評分系統實現文檔

## 概述

本文檔描述了活動評分系統的完整實現，包括評分彈窗、數據存儲、評分顯示等功能。

## 功能特性

### 1. 評分彈窗 (ActivityRatingPopup)
- **位置**: `lib/components/design_system/activity_rating_popup.dart`
- **功能**:
  - 從底部彈出的評分界面
  - 支持多個主辦方的滾動顯示
  - 5星評分系統
  - 可選評論功能
  - 可跳過評分
  - 動畫效果

### 2. 數據存儲
- **Firestore 集合**: `activity_ratings`
- **文檔結構**:
  ```json
  {
    "activityId": "活動ID",
    "raterId": "評分者ID", 
    "ratings": {
      "主辦方ID": 評分數值
    },
    "comment": "評論內容",
    "createdAt": "創建時間",
    "updatedAt": "更新時間"
  }
  ```

### 3. 用戶評分統計更新
- 自動更新被評分用戶的平均評分
- 更新評分次數統計
- 保持評分歷史記錄

### 4. 評分顯示
- 在活動詳情頁顯示過去評價區塊
- 顯示評分者資訊、評分星級、評論內容
- 按時間倒序排列

## 觸發條件

評分彈窗會在以下條件全部滿足時自動顯示：

1. 用戶已登入
2. 用戶已報名該活動
3. 活動已結束
4. 用戶尚未對該活動評分

## 核心方法

### ActivityService 新增方法

#### `submitActivityRating()`
提交活動評分到 Firestore

#### `getActivityRatings()`
獲取活動的評分列表

#### `hasUserRatedActivity()`
檢查用戶是否已評分

#### `shouldShowRatingPopup()`
檢查是否應顯示評分彈窗

#### `_updateUserRatingStats()`
更新用戶評分統計

### ActivityDetailPage 新增方法

#### `_checkAndShowRatingPopup()`
檢查並顯示評分彈窗

#### `_showRatingPopup()`
顯示評分彈窗

#### `_handleRatingSubmit()`
處理評分提交

#### `_loadActivityRatings()`
載入活動評分數據

#### `_buildPastRatingsSection()`
建構過去評價區塊

#### `_buildRatingItem()`
建構單個評價項目

## 使用流程

1. **用戶參與活動**: 用戶報名並參與活動
2. **活動結束**: 活動結束時間過後
3. **自動彈出評分**: 用戶打開活動詳情頁時自動彈出評分界面
4. **用戶評分**: 用戶可以給主辦方評分並留下評論
5. **數據存儲**: 評分數據保存到 Firestore
6. **統計更新**: 自動更新主辦方的評分統計
7. **評分顯示**: 評分會顯示在活動詳情頁的過去評價區塊

## 技術實現細節

### 評分彈窗設計
- 使用 `SlideTransition` 和 `FadeTransition` 實現動畫效果
- 支持單個或多個主辦方的評分
- 多個主辦方時使用 `PageView` 實現滾動顯示
- 包含頁面指示器

### 數據一致性
- 使用文檔ID `${raterId}_${activityId}` 確保每個用戶只能對同一活動評分一次
- 評分提交時會檢查是否已存在評分記錄

### 性能優化
- 評分數據延遲載入，不影響主要頁面載入速度
- 使用限制查詢 (limit) 控制評分列表大小
- 評分統計更新失敗不會影響評分提交

## 未來擴展

1. **評分篩選**: 可以按評分等級篩選評價
2. **評分回覆**: 主辦方可以回覆評價
3. **評分統計圖表**: 顯示評分分布圖表
4. **評分提醒**: 活動結束後推送評分提醒
5. **匿名評分**: 支持匿名評分選項

## 注意事項

1. 評分彈窗會在頁面載入後延遲 1.5 秒顯示，確保頁面完全載入
2. 評分數據存儲在獨立的 `activity_ratings` 集合中，便於管理和查詢
3. 用戶評分統計更新是異步進行的，不會阻塞評分提交
4. 評分顯示區塊只在有評分數據時才會顯示

## 測試建議

1. 測試評分彈窗的顯示條件
2. 測試多個主辦方的滾動顯示
3. 測試評分數據的正確存儲
4. 測試用戶評分統計的更新
5. 測試評分顯示的正確性
6. 測試重複評分的防護機制
