# 提前結束活動功能實現文檔

## 概述

本文檔描述了在活動詳情頁面新增的"提前結束活動"功能，允許活動主辦者在活動預定結束時間之前手動結束活動，並觸發評分流程。

## 功能特性

### 1. 提前結束按鈕顯示條件

按鈕只會在以下條件全部滿足時顯示：

- ✅ 當前用戶是活動主辦者 (`_isMyActivity = true`)
- ✅ 活動存在且數據完整
- ✅ 活動狀態為 `active`（已上架）
- ✅ 當前時間早於活動預定結束時間

### 2. 按鈕位置和設計

- **位置**: 活動詳情頁面內容區最下方，過去評價區塊之後
- **樣式**: Outline 按鈕，紅色邊框和文字，表示這是一個重要操作
- **圖標**: 停止圓圈圖標 (`Icons.stop_circle_outlined`)
- **包含說明**: 解釋提前結束的後果和流程

### 3. 確認對話框

點擊按鈕後會顯示確認對話框，包含：

- **標題**: "確認提前結束活動"
- **說明**: 清楚說明操作後果
- **警告項目**:
  - 活動狀態將變更為「已結束」
  - 參與者將收到評分邀請
  - 此操作無法撤銷
- **操作按鈕**: 取消 / 確認結束

## 技術實現

### 核心方法

#### `_shouldShowEarlyEndButton()`
```dart
bool _shouldShowEarlyEndButton() {
  // 檢查是否應顯示提前結束按鈕的邏輯
  // 包含主辦者身份、活動狀態、時間等條件驗證
}
```

#### `_buildEarlyEndButton()`
```dart
Widget _buildEarlyEndButton() {
  // 建構提前結束按鈕的 UI
  // 包含標題、說明文字和按鈕
}
```

#### `_showEarlyEndConfirmDialog()`
```dart
void _showEarlyEndConfirmDialog() {
  // 顯示確認對話框
  // 讓用戶確認是否真的要提前結束活動
}
```

#### `_handleEarlyEndActivity()`
```dart
Future<void> _handleEarlyEndActivity() async {
  // 處理提前結束活動的核心邏輯
  // 更新活動狀態並觸發相關流程
}
```

### 狀態更新流程

1. **狀態變更**: 將活動狀態從 `active` 更新為 `ended`
2. **數據同步**: 更新 Firestore 中的活動文檔
3. **界面刷新**: 重新載入活動詳情和相關頁面
4. **通知更新**: 觸發我的活動頁面和首頁的數據重整

### 評分流程觸發

活動提前結束後，評分系統會自動生效：

- 參與者再次打開活動詳情頁時，會檢查活動是否已結束
- 如果活動已結束且用戶尚未評分，會自動顯示評分彈窗
- 主辦者不會看到評分彈窗（因為不會評分自己的活動）

## 用戶體驗流程

### 主辦者操作流程

1. **查看活動**: 主辦者打開自己發布的進行中活動
2. **發現按鈕**: 在頁面底部看到"提前結束活動"按鈕
3. **點擊按鈕**: 點擊後彈出確認對話框
4. **確認操作**: 閱讀警告後確認提前結束
5. **狀態更新**: 活動狀態變為已結束，按鈕消失
6. **完成操作**: 收到成功提示，相關頁面自動更新

### 參與者體驗流程

1. **活動結束**: 主辦者提前結束活動
2. **打開詳情**: 參與者打開該活動詳情頁
3. **評分邀請**: 自動彈出評分界面
4. **進行評分**: 對主辦者進行評分和評論
5. **完成評分**: 評分記錄保存，顯示在活動詳情中

## 安全性和驗證

### 權限控制
- 只有活動主辦者才能看到和使用此功能
- 通過 `_isMyActivity` 標誌進行身份驗證
- 前端和後端都有相應的權限檢查

### 狀態驗證
- 只有 `active` 狀態的活動才能被提前結束
- 檢查活動是否真的還在進行中（未到預定結束時間）
- 防止重複操作和無效操作

### 數據一致性
- 使用 Firestore 事務確保狀態更新的原子性
- 更新後立即重新載入數據確保界面同步
- 觸發相關頁面的數據重整

## 錯誤處理

### 網絡錯誤
- 顯示友好的錯誤提示
- 不會改變活動狀態
- 允許用戶重試操作

### 權限錯誤
- 如果用戶不是主辦者，按鈕不會顯示
- 後端會進行額外的權限驗證

### 狀態衝突
- 如果活動已經結束，操作會失敗
- 顯示相應的錯誤信息

## 未來擴展可能

1. **通知系統**: 提前結束時向參與者發送推送通知
2. **結束原因**: 允許主辦者填寫提前結束的原因
3. **部分退款**: 如果是付費活動，可以集成退款邏輯
4. **統計分析**: 記錄提前結束的活動數據用於分析
5. **批量操作**: 允許主辦者批量結束多個活動

## 測試建議

### 功能測試
1. 測試按鈕顯示條件的各種情況
2. 測試確認對話框的交互
3. 測試提前結束操作的成功流程
4. 測試錯誤情況的處理

### 權限測試
1. 非主辦者不應看到按鈕
2. 已結束的活動不應顯示按鈕
3. 草稿狀態的活動不應顯示按鈕

### 評分流程測試
1. 提前結束後參與者應能看到評分彈窗
2. 主辦者不應看到評分彈窗
3. 評分數據應正確保存和顯示

## 注意事項

1. **不可逆操作**: 提前結束是不可逆的，需要用戶明確確認
2. **評分觸發**: 提前結束會立即觸發評分流程，參與者可以馬上評分
3. **狀態同步**: 操作後會自動刷新相關頁面的數據
4. **用戶體驗**: 操作過程中會顯示載入狀態和成功/失敗提示
