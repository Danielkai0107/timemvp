# 用戶資料卡片彈窗功能實現文檔

## 概述

本文檔描述了用戶資料卡片彈窗功能的完整實現，讓用戶可以在報名人員名單中點擊頭像查看其他用戶的詳細資料和評價。

## 功能特性

### 1. 用戶資料卡片彈窗 (UserProfilePopup)
- **位置**: `lib/components/design_system/user_profile_popup.dart`
- **功能**:
  - 從底部彈出的用戶資料界面
  - 顯示用戶基本資訊（頭像、姓名、認證狀態）
  - 顯示雙向評分統計（發布者評分 + 參與者評分）
  - 水平滾動顯示用戶收到的評價
  - 區分作為發布者和參與者的評價
  - 優雅的動畫效果

### 2. 報名狀況彈窗整合
- **修改文件**: `lib/components/design_system/registration_status_popup.dart`
- **功能**:
  - 頭像變為可點擊狀態
  - 點擊頭像觸發用戶資料卡片彈窗
  - 傳遞預載的用戶數據以提升性能

## 用戶資料卡片設計

### 卡片結構
```
┌─────────────────────────────────────┐
│  [拖拽指示器]              [關閉按鈕] │
├─────────────────────────────────────┤
│  ┌─────────────────────────────────┐ │
│  │  [大頭像]  [姓名 + 認證標誌]    │ │
│  │           [發布者評分]         │ │
│  │           [參與者評分]         │ │
│  └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│  [用戶資訊區塊]                     │
├─────────────────────────────────────┤
│  用戶評價                           │
│  ┌─────────────────────────────────┐ │
│  │ 作為發布者的評價 (水平滾動)      │ │
│  └─────────────────────────────────┘ │
│  ┌─────────────────────────────────┐ │
│  │ 作為參與者的評價 (水平滾動)      │ │
│  └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 認證標誌系統
- **已認證**: 綠色標誌 + "身份已認證" / "企業已認證"
- **審核中**: 橙色標誌 + "審核中" / "企業審核中"
- **未認證**: 灰色標誌 + "未認證" / "企業未認證"

### 評分統計顯示
- **發布者評分**: 用戶作為活動發布者收到的評分
- **參與者評分**: 用戶作為活動參與者收到的評分
- 顯示平均分數和評分次數

## 技術實現細節

### 動畫效果
- 使用 `SlideTransition` 實現底部滑入動畫
- 使用 `FadeTransition` 實現背景遮罩淡入效果
- 動畫時長：300ms，使用 `Curves.easeOutCubic` 曲線

### 數據載入策略
1. **預載數據優先**: 如果有預載的用戶數據，先顯示基本資訊
2. **異步載入評分**: 並行載入兩種類型的評分數據
3. **錯誤處理**: 載入失敗時顯示預設內容

### 評分數據整合
```dart
// 同時載入兩種評分
final results = await Future.wait([
  _activityService.getUserReceivedRatings(userId: widget.userId, limit: 5),
  _activityService.getUserParticipantRatings(userId: widget.userId, limit: 5),
]);
```

### 評價卡片設計
- **寬度**: 200px 固定寬度
- **內容**: 評價者頭像、姓名、星級評分、評論內容、日期
- **滾動**: 水平滾動顯示多個評價
- **樣式**: 白色背景 + 灰色邊框

## 使用流程

### 1. 觸發流程
1. 用戶打開活動詳情頁
2. 點擊「查看報名狀況」按鈕
3. 在報名人員列表中點擊任一用戶頭像
4. 彈出該用戶的資料卡片

### 2. 資料載入流程
1. 顯示用戶基本資訊（如果有預載數據）
2. 顯示載入動畫
3. 並行載入評分數據
4. 更新界面顯示完整資訊

### 3. 互動流程
- **關閉彈窗**: 點擊關閉按鈕或背景遮罩
- **查看評價**: 水平滑動查看更多評價
- **動畫退出**: 滑出動畫後關閉彈窗

## 數據結構

### 用戶基本資料
```dart
{
  'id': '用戶ID',
  'name': '用戶姓名',
  'avatar': '頭像URL',
  'status': '用戶狀態', // pending, approved
  'kycStatus': 'KYC狀態', // pending, approved, rejected
  'accountType': '帳號類型', // personal, business
  'rating': '發布者評分',
  'participantRating': '參與者評分',
  'participantRatingCount': '參與者評分次數'
}
```

### 評分記錄
```dart
{
  'id': '評分記錄ID',
  'rater': '評分者資訊', // 或 'organizer' 對於參與者評分
  'userRating': '具體評分',
  'comment': '評論內容',
  'createdAt': '創建時間',
  'activity': '相關活動資訊'
}
```

## 性能優化

### 1. 預載數據利用
- 利用報名列表中已載入的用戶基本資料
- 避免重複的網路請求
- 提升彈窗開啟速度

### 2. 並行載入
- 同時載入兩種類型的評分數據
- 減少總載入時間
- 提升用戶體驗

### 3. 限制評分數量
- 每種評分類型限制載入 5 筆
- 減少數據傳輸量
- 保持界面簡潔

### 4. 錯誤處理
- 載入失敗時顯示預設內容
- 不阻塞基本資訊顯示
- 提供重試機制

## 相關文件

- `lib/components/design_system/user_profile_popup.dart` - 用戶資料卡片彈窗組件
- `lib/components/design_system/registration_status_popup.dart` - 修改後的報名狀況彈窗
- `lib/services/activity_service.dart` - 評分數據服務
- `lib/services/user_service.dart` - 用戶資料服務

## 測試建議

### 1. 基本功能測試
- 點擊頭像是否正確彈出用戶資料卡片
- 用戶基本資訊是否正確顯示
- 認證標誌是否根據狀態正確顯示

### 2. 評分數據測試
- 發布者評分和參與者評分是否正確區分
- 評價卡片是否正確顯示評分者資訊
- 水平滾動是否正常工作

### 3. 動畫效果測試
- 彈窗開啟和關閉動畫是否流暢
- 背景遮罩效果是否正確
- 拖拽指示器是否顯示

### 4. 錯誤處理測試
- 網路錯誤時是否正確處理
- 用戶數據不存在時是否顯示預設內容
- 評分數據載入失敗時是否正確處理

### 5. 性能測試
- 彈窗開啟速度是否滿足要求
- 大量評分數據時是否影響性能
- 記憶體使用是否正常

## 未來擴展建議

### 1. 更多用戶資訊
- 顯示用戶參與的活動數量
- 顯示用戶加入時間
- 顯示用戶專長或興趣

### 2. 互動功能
- 添加私訊功能
- 添加關注功能
- 添加舉報功能

### 3. 評價功能增強
- 支持評價回覆
- 支持評價點讚
- 支持評價篩選

### 4. 個人化設置
- 支持隱私設置
- 支持資料可見性控制
- 支持評價顯示偏好

## 注意事項

1. **隱私保護**: 確保只顯示用戶允許公開的資訊
2. **性能考量**: 避免載入過多評分數據影響性能
3. **用戶體驗**: 保持彈窗開啟速度和動畫流暢度
4. **錯誤處理**: 妥善處理各種異常情況
5. **數據一致性**: 確保顯示的評分數據是最新的

## 設計原則

1. **簡潔明瞭**: 突出重要資訊，避免資訊過載
2. **一致性**: 與應用整體設計風格保持一致
3. **可用性**: 確保所有互動元素都易於使用
4. **回饋性**: 提供適當的載入和錯誤狀態回饋
5. **可訪問性**: 考慮不同用戶的使用需求
